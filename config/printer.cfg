# =============================================================
#   BTT Manta M5P
# =============================================================
[mcu]
canbus_uuid: 3a29827ac728


# =============================================================
#   Mellow SB2040 PRO V3
# =============================================================
[mcu SB2040]
canbus_uuid: d86a995401c3


# =============================================================
#   PRINTER SETTINGS
# =============================================================
[printer]
kinematics: corexz
max_velocity: 200
max_accel: 1000
minimum_cruise_ratio: 0.5
square_corner_velocity: 4.0
max_z_velocity: 50
max_z_accel: 1000


# -------------------------------------------------------------
#   STEPPER X  (Motor M1)
# -------------------------------------------------------------
[stepper_x]
step_pin: PC8
dir_pin: PC9
enable_pin: !PA15
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: ^SB2040:gpio20
position_min: 0
position_endstop: 251
position_max: 251
homing_speed: 70
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: PD9
run_current: 0.96152
stealthchop_threshold: 999999


# -------------------------------------------------------------
#   STEPPER Y  (Motor M3)
# -------------------------------------------------------------
[stepper_y]
step_pin: PC6
dir_pin: !PC7
enable_pin: !PA9
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: !PC3
position_min: -30
position_endstop: 221
position_max: 221
homing_speed: 70
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: PB10
run_current: 1.01808
stealthchop_threshold: 999999


# -------------------------------------------------------------
#   STEPPER Z  (Motor M2)
# -------------------------------------------------------------
[stepper_z]
step_pin: PA10
dir_pin: PA14
enable_pin: !PA13
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop
position_min: -3.0
position_max: 250
homing_speed: 40
homing_positive_dir: false

[tmc2209 stepper_z]
uart_pin: PD8
run_current: 0.96152
stealthchop_threshold: 999999


# -------------------------------------------------------------
#   EXTRUDER
# -------------------------------------------------------------
[extruder]
step_pin: SB2040:gpio14
dir_pin: !SB2040:gpio13
enable_pin: !SB2040:gpio16
microsteps: 16
rotation_distance: 23.039683182447  # https://www.service-uplink.de/esteps_cal/calculator.php
full_steps_per_rotation: 200
gear_ratio: 50:8
nozzle_diameter: 0.400
filament_diameter: 1.75
max_extrude_only_distance: 100.0
pressure_advance: 0.045
pressure_advance_smooth_time: 0.045
heater_pin: SB2040:gpio23
max_power: 1.0
sensor_type: ATC Semitec 104GT-2
sensor_pin: SB2040:gpio27
min_extrude_temp: 10
min_temp: 10
max_temp: 270

[tmc2240 extruder]
uart_pin: SB2040:gpio15
interpolate: False
run_current: 0.65
rref: 12300
stealthchop_threshold: 0
driver_TPFD: 0


# -------------------------------------------------------------
#   HEATER BED
# -------------------------------------------------------------
[heater_bed]
heater_pin: PA5
sensor_type: Generic 3950
sensor_pin: PA0
min_temp: 0
max_temp: 130


# -------------------------------------------------------------
#   BED MESH
# -------------------------------------------------------------
[bed_mesh]
speed: 100
horizontal_move_z: 5
mesh_min: 25.0, 25.0
mesh_max: 225.0, 185.0
probe_count: 7,7
fade_start: 1.0
fade_end: 10.0
fade_target: 0
algorithm: bicubic
zero_reference_position: 125, 101
adaptive_margin: 5


# -------------------------------------------------------------
#   SCREWS TILT ADJUST (disabled)
# -------------------------------------------------------------
# [screws_tilt_adjust]
# SW Nylock Mod: Screw 1 uses the 6mm metal spacer,
# so its height is the baseline for SCREWS_TILT_CALCULATE.
#
# Screw layout:
#         ******************
#         * S7    S8    S9 *
#         *                *
#   Bed:  * S5    S1    S6 *
#         *                *
#         * S2    S3    S4 *
#         ******************
#
# screw1: 126, 81        # center
# screw2: 16, -24        # front_left
# screw3: 126, -24       # front_center
# screw4: 232, -24       # front_right
# screw5: 16, 81         # middle_left
# screw6: 232, 81        # middle_right
# screw7: 16, 186        # rear_left
# screw8: 126, 186       # rear_center
# screw9: 232, 186       # rear_right
# horizontal_move_z: 10
# speed: 50
# screw_thread: CCW-M3


# -------------------------------------------------------------
#   SAFE Z HOME
# -------------------------------------------------------------
[safe_z_home]
home_xy_position: 125, 101
speed: 200
z_hop: 20
z_hop_speed: 25


# -------------------------------------------------------------
#   MACROS
# -------------------------------------------------------------
[gcode_macro PAUSE]
description: Pause the current print, retract filament and park the head
rename_existing: PAUSE_BASE
variable_extrude: 1.0
gcode:
    # Get configured retract amount from macro variable
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}

    # Determine park position (near XY max, 5 mm margin)
    {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
    {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}

    # Compute safe Z lift without exceeding Z max
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% if act_z < (max_z - 2.0) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}

    PAUSE_BASE
    G91

    # Retract filament if hot enough
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-{E} F2100
    {% else %}
        {action_respond_info("Extruder not hot enough")}
    {% endif %}

    # Lift and park only if printer is homed
    {% if "xyz" in printer.toolhead.homed_axes %}
        G1 Z{z_safe} F900
        G90
        G1 X{x_park} Y{y_park} F6000
    {% else %}
        {action_respond_info("Printer not homed")}
    {% endif %}


[gcode_macro RESUME]
description: Resume the current print and restore filament
rename_existing: RESUME_BASE
gcode:
    # Read retract amount from PAUSE macro
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}

    # Optional VELOCITY override from parameters
    {% if 'VELOCITY' in params|upper %}
        {% set get_params = ('VELOCITY=' + params.VELOCITY) %}
    {% else %}
        {% set get_params = "" %}
    {% endif %}

    # Re-prime filament if hot enough
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G91
        G1 E{E} F2100
    {% else %}
        {action_respond_info("Extruder not hot enough")}
    {% endif %}
    RESUME_BASE {get_params}


[gcode_macro CANCEL_PRINT]
description: Cancel the current print and reset printer state
rename_existing: BASE_CANCEL_PRINT
gcode:
    # Wait for move buffer to empty
    M400
    # Park X/Y at home
    G28 X Y
    # Turn off part cooling fan
    M107
    # Turn off all heaters
    TURN_OFF_HEATERS
    # Clear mesh and pause state, reset virtual SD
    BED_MESH_CLEAR
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT


[gcode_macro START_PRINT]
description: Standard start sequence with bed mesh and safe nozzle heating
gcode:
    # Get BED/NOZZLE temps, plus safe temp for probing
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set EXTRUDER_SAFE = params.EXTRUDER_SAFE|default(170)|float %}

    # Absolute coordinates
    G90

    # Start heating bed and nozzle (safe temp for probing)
    M140 S{BED_TEMP}
    M104 S{EXTRUDER_SAFE}

    # Home XY on cold bed (XY geometry not temperature dependent)
    G28 X Y

    # Wait for bed to reach working temperature
    M190 S{BED_TEMP}

    # Home Z on hot bed for correct Z offset
    G28 Z

    # Clear old mesh and probe at working temperatures
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE ADAPTIVE=1

    # Move Z up to a safe height
    G1 Z20.0 F3000

    # Heat nozzle to printing temperature and wait
    M109 S{EXTRUDER_TEMP}

    # Zero extruder position
    G92 E0


[gcode_macro END_PRINT]
description: Standard end sequence to park, cool down and disable motors
gcode:
    # Wait for buffer to empty
    M400
    # Park X/Y at home
    G28 X Y
    # Turn off part cooling fan
    M107
    # Turn off heaters
    TURN_OFF_HEATERS
    # Clear mesh and disable steppers
    BED_MESH_CLEAR
    M84


# -------------------------------------------------------------
#   FILAMENT PROFILE / MATERIAL SELECTION
# -------------------------------------------------------------
[gcode_macro SET_FILAMENT_PROFILE]
description: Set active filament profile (PLA / PETG / ABS) for load/unload macros
variable_material: "PLA"
gcode:
    # MATERIAL parameter selects filament type, default PLA
    {% set mat = params.MATERIAL|default("PLA")|upper %}
    {% if mat not in ["PLA", "PETG", "ABS"] %}
        {action_respond_info("Unknown material: " ~ mat ~ ". Use PLA / PETG / ABS.")}
    {% else %}
        # Store selected material in macro variable
        SET_GCODE_VARIABLE MACRO=SET_FILAMENT_PROFILE VARIABLE=material VALUE="'{mat}'"
        {action_respond_info("Active filament profile set to: " ~ mat)}
    {% endif %}


# -------------------------------------------------------------
#   INTERNAL: RESOLVE FILAMENT TEMPERATURE
# -------------------------------------------------------------
[gcode_macro _GET_FILAMENT_TEMP]
description: Internal helper macro - map filament profile to target nozzle temperature
variable_last_temp: 220
gcode:
    # Read current filament profile
    {% set mat = printer["gcode_macro SET_FILAMENT_PROFILE"].material|upper %}

    # Map material to target temperature (adjust to your filaments)
    {% if mat == "PLA" %}
        {% set temp = 215 %}
    {% elif mat == "PETG" %}
        {% set temp = 240 %}
    {% elif mat == "ABS" %}
        {% set temp = 245 %}
    {% else %}
        {% set temp = 220 %}
    {% endif %}

    {action_respond_info("Filament profile: " ~ mat ~ ", target temp: " ~ temp|string ~ "Â°C")}

    # Store last resolved temperature for use in other macros
    SET_GCODE_VARIABLE MACRO=_GET_FILAMENT_TEMP VARIABLE=last_temp VALUE={temp}


# -------------------------------------------------------------
#   FILAMENT WRAPPER MACROS (for KlipperScreen menu)
# -------------------------------------------------------------

[gcode_macro LOAD_PLA]
description: Load PLA using current filament profile logic
gcode:
    SET_FILAMENT_PROFILE MATERIAL=PLA
    LOAD_FILAMENT

[gcode_macro LOAD_PETG]
description: Load PETG using current filament profile logic
gcode:
    SET_FILAMENT_PROFILE MATERIAL=PETG
    LOAD_FILAMENT

[gcode_macro LOAD_ABS]
description: Load ABS using current filament profile logic
gcode:
    SET_FILAMENT_PROFILE MATERIAL=ABS
    LOAD_FILAMENT


[gcode_macro UNLOAD_PLA]
description: Unload PLA using current filament profile logic
gcode:
    SET_FILAMENT_PROFILE MATERIAL=PLA
    UNLOAD_FILAMENT

[gcode_macro UNLOAD_PETG]
description: Unload PETG using current filament profile logic
gcode:
    SET_FILAMENT_PROFILE MATERIAL=PETG
    UNLOAD_FILAMENT

[gcode_macro UNLOAD_ABS]
description: Unload ABS using current filament profile logic
gcode:
    SET_FILAMENT_PROFILE MATERIAL=ABS
    UNLOAD_FILAMENT


# -------------------------------------------------------------
#   LOAD FILAMENT (KlipperScreen, with auto-heat)
# -------------------------------------------------------------
[gcode_macro LOAD_FILAMENT]
description: Load filament (KlipperScreen) with auto-heating based on filament profile
variable_load_distance: 50      # fast load distance (mm)
variable_purge_distance: 25     # purge distance (mm)
gcode:
    # 1. Determine target temperature:
    #    - if TEMP param is provided, use it
    #    - otherwise derive from filament profile
    {% if "TEMP" in params %}
        {% set target = params.TEMP|float %}
    {% else %}
        _GET_FILAMENT_TEMP
        {% set target = printer["gcode_macro _GET_FILAMENT_TEMP"].last_temp|float %}
    {% endif %}

    # Heat nozzle and wait until target temperature is reached
    M104 S{target}
    M109 S{target}

    # Read distances from macro variables
    {% set load_distance   = printer["gcode_macro LOAD_FILAMENT"].load_distance|float %}
    {% set purge_distance  = printer["gcode_macro LOAD_FILAMENT"].purge_distance|float %}

    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0

    # Perform fast load and then a slow purge
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E{load_distance}  F3000      ; fast load
        G1 E{purge_distance} F300       ; slow purge / cleaning
    {% else %}
        {action_respond_info("Extruder not hot enough for LOAD_FILAMENT")}
    {% endif %}

    RESTORE_GCODE_STATE NAME=load_state


# -------------------------------------------------------------
#   UNLOAD FILAMENT (KlipperScreen, with auto-heat)
# -------------------------------------------------------------
[gcode_macro UNLOAD_FILAMENT]
description: Unload filament (KlipperScreen) with auto-heating based on filament profile
variable_unload_distance: 80    # fast unload distance (mm)
variable_purge_distance: 10     # small purge before unload (mm)
gcode:
    # Determine target temperature from TEMP or filament profile
    {% if "TEMP" in params %}
        {% set target = params.TEMP|float %}
    {% else %}
        _GET_FILAMENT_TEMP
        {% set target = printer["gcode_macro _GET_FILAMENT_TEMP"].last_temp|float %}
    {% endif %}

    # Heat nozzle and wait
    M104 S{target}
    M109 S{target}

    # Read distances from macro variables
    {% set unload_distance = printer["gcode_macro UNLOAD_FILAMENT"].unload_distance|float %}
    {% set purge_distance  = printer["gcode_macro UNLOAD_FILAMENT"].purge_distance|float %}

    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0

    # Small purge to soften filament, then fast retract to unload
    {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E{purge_distance}    F300    ; small purge
        G1 E-{unload_distance}  F3000   ; fast unload
    {% else %}
        {action_respond_info("Extruder not hot enough for UNLOAD_FILAMENT")}
    {% endif %}

    RESTORE_GCODE_STATE NAME=unload_state


# -------------------------------------------------------------
#   GENERAL SETTINGS
# -------------------------------------------------------------
[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[force_move]
enable_force_move: true

[pause_resume]
recover_velocity: 50

[respond]

[exclude_object]


# -------------------------------------------------------------
#   INPUT SHAPING / SENSORS
# -------------------------------------------------------------
[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 56.2
shaper_type_y: mzv
shaper_freq_y: 50.6

[adxl345]
cs_pin: PC0
spi_software_sclk_pin: PB13
spi_software_mosi_pin: PB15
spi_software_miso_pin: PB14

[lis2dw]
cs_pin: SB2040:gpio12
spi_software_sclk_pin: SB2040:gpio2
spi_software_mosi_pin: SB2040:gpio3
spi_software_miso_pin: SB2040:gpio4

[resonance_tester]
probe_points: 125, 105, 20
accel_chip_x: lis2dw
accel_chip_y: adxl345
min_freq: 5
max_freq: 133.33
accel_per_hz: 75
hz_per_sec: 1


# -------------------------------------------------------------
#   PROBE
# -------------------------------------------------------------
[probe]
pin: SB2040:gpio22
x_offset: 0.0
y_offset: 25.0
speed: 40.0
samples: 3
sample_retract_dist: 3.0
lift_speed: 5.0
samples_result: median
samples_tolerance: 0.100
samples_tolerance_retries: 3


# -------------------------------------------------------------
#   HEATER VERIFICATION
# -------------------------------------------------------------
[verify_heater extruder]
max_error: 20
check_gain_time: 120
hysteresis: 50
heating_gain: 2

[verify_heater heater_bed]
max_error: 20
check_gain_time: 120
hysteresis: 50
heating_gain: 2


# -------------------------------------------------------------
#   MCU TEMPERATURES
# -------------------------------------------------------------
[temperature_sensor BTT_MANTA_M5P]
sensor_type: temperature_mcu

[temperature_sensor FLY_SB2040]
sensor_type: temperature_mcu
sensor_mcu: SB2040


# -------------------------------------------------------------
#   FANS
# -------------------------------------------------------------
[fan]
pin: SB2040:gpio24

[heater_fan hotend_fan]
pin: SB2040:gpio19
heater: extruder
heater_temp: 50.0

[controller_fan mcu]
pin: PA4
max_power: 0.75
kick_start_time: 0.200
idle_speed: 0.50
heater: heater_bed
stepper: stepper_x, stepper_y, stepper_z


# -------------------------------------------------------------
#   NEOPIXELS
# -------------------------------------------------------------
[neopixel head]
pin: SB2040:gpio26
chain_count: 12
color_order: GRBW
initial_RED: 1.0
initial_GREEN: 0.6471
initial_BLUE: 0.0
initial_WHITE: 0.0


[display_status]

[shaketune]


# -------------------------------------------------------------
#   AUTO-GENERATED DATA
# -------------------------------------------------------------
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.913
#*# pid_ki = 2.433
#*# pid_kd = 68.995
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.832
#*# pid_ki = 0.904
#*# pid_kd = 892.967
#*#
#*# [probe]
#*# z_offset = 1.800
